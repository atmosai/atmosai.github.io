<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>数据处理速度提升1000+倍 | bugsuse</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="About LoveIt Theme"><link rel=prev href=https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/><link rel=canonical href=https://atmosai.github.io/2020/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="数据处理速度提升1000+倍"><meta property="og:description" content="1 2 3 4 5 6 7 8 9 10 import pandas as pd import numpy as np import re import time from IPython.core.interactiveshell import InteractiveShell InteractiveShell.ast_node_interactivity = &#34;all&#34; pd.set_option('max_columns', 15) pd.set_option('chained_assignment', None) 读取数据 此CSV示例数据是用于练习如何向量化.apply函数时使用。数据已"><meta property="og:type" content="article"><meta property="og:url" content="https://atmosai.github.io/2020/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D/"><meta property="article:published_time" content="2020-01-28T18:58:51+08:00"><meta property="article:modified_time" content="2020-01-28T18:58:51+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="数据处理速度提升1000+倍"><meta name=twitter:description content="1 2 3 4 5 6 7 8 9 10 import pandas as pd import numpy as np import re import time from IPython.core.interactiveshell import InteractiveShell InteractiveShell.ast_node_interactivity = &#34;all&#34; pd.set_option('max_columns', 15) pd.set_option('chained_assignment', None) 读取数据 此CSV示例数据是用于练习如何向量化.apply函数时使用。数据已"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"数据处理速度提升1000\x2b倍","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/atmosai.github.io\/2020\/01\/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D\/"},"image":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"python, pandas, numpy","wordcount":3325,"url":"https:\/\/atmosai.github.io\/2020\/01\/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D\/","datePublished":"2020-01-28T18:58:51\x2b08:00","dateModified":"2020-01-28T18:58:51\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=navbar-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">数据处理速度提升1000+倍</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://i-lightning.cn rel=author target=_blank><i class="fas fa-user-circle fa-fw"></i>bugsuse
</a>&nbsp;<span class=post-category>included in&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://atmosai.github.io/categories/tools/>Tools</a>&nbsp;</span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-01-28>2020-01-28</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 3325 words&nbsp;
<i class="far fa-clock fa-fw"></i>7 min&nbsp;</div></div><div class=post-featured-image><img src=/svg/loading.min.svg data-sizes=auto data-src=/img/pandas.jpeg alt="featured image" class=lazyload></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#读取数据>读取数据</a><ul><li><a href=#数据检查>数据检查</a></li></ul></li><li><a href=#条件表达式的向量化>条件表达式的向量化</a></li><li><a href=#npwhere>np.where</a></li><li><a href=#npvectorize>np.vectorize</a></li><li><a href=#多条件处理>多条件处理</a></li><li><a href=#npselect>np.select</a></li><li><a href=#向量化多条件表达式>向量化多条件表达式</a></li><li><a href=#复杂示例>复杂示例</a><ul><li><a href=#字符串>字符串</a></li><li><a href=#字典查表>字典查表</a></li><li><a href=#日期>日期</a></li><li><a href=#逻辑表达式所需要的值在其他行>逻辑表达式所需要的值在其他行</a></li></ul></li><li><a href=#其他方法>其他方法</a><ul><li><a href=#并行函数>并行函数</a></li></ul></li><li><a href=#参考链接>参考链接：</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#读取数据>读取数据</a><ul><li><a href=#数据检查>数据检查</a></li></ul></li><li><a href=#条件表达式的向量化>条件表达式的向量化</a></li><li><a href=#npwhere>np.where</a></li><li><a href=#npvectorize>np.vectorize</a></li><li><a href=#多条件处理>多条件处理</a></li><li><a href=#npselect>np.select</a></li><li><a href=#向量化多条件表达式>向量化多条件表达式</a></li><li><a href=#复杂示例>复杂示例</a><ul><li><a href=#字符串>字符串</a></li><li><a href=#字典查表>字典查表</a></li><li><a href=#日期>日期</a></li><li><a href=#逻辑表达式所需要的值在其他行>逻辑表达式所需要的值在其他行</a></li></ul></li><li><a href=#其他方法>其他方法</a><ul><li><a href=#并行函数>并行函数</a></li></ul></li><li><a href=#参考链接>参考链接：</a></li></ul></li></ul></nav></div></details></div><div class=post-content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pandas</span> <span class=kn>as</span> <span class=nn>pd</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=kn>as</span> <span class=nn>np</span>
<span class=kn>import</span> <span class=nn>re</span>
<span class=kn>import</span> <span class=nn>time</span>

<span class=kn>from</span> <span class=nn>IPython.core.interactiveshell</span> <span class=kn>import</span> <span class=n>InteractiveShell</span>
<span class=n>InteractiveShell</span><span class=o>.</span><span class=n>ast_node_interactivity</span> <span class=o>=</span> <span class=sa></span><span class=s2>&#34;</span><span class=s2>all</span><span class=s2>&#34;</span>

<span class=n>pd</span><span class=o>.</span><span class=n>set_option</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>max_columns</span><span class=s1>&#39;</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>
<span class=n>pd</span><span class=o>.</span><span class=n>set_option</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>chained_assignment</span><span class=s1>&#39;</span><span class=p>,</span> <span class=bp>None</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=读取数据></a><h3>读取数据</h3><p>此CSV示例数据是用于练习如何向量化<code>.apply</code>函数时使用。数据已经进行了清洗和预处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>sample_data_pygotham2019.csv</span><span class=s1>&#39;</span><span class=p>,</span> 
                 <span class=n>parse_dates</span><span class=o>=</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>注：<code>parse_dates</code> 参数可将给定的列进行解析为日期格式。</p><a class=post-dummy-target id=数据检查></a><h4>数据检查</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>df</span><span class=o>.</span><span class=n>shape</span>
<span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>df</span><span class=o>.</span><span class=n>dtypes</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>Internal</span> <span class=n>ID</span>                               <span class=n>int64</span>
<span class=n>ID</span>                                        <span class=n>int64</span>
<span class=n>Category</span>                                 <span class=nb>object</span>
<span class=n>Lead</span> <span class=n>Source</span>                              <span class=nb>object</span>
<span class=n>Lead</span> <span class=n>Source</span> <span class=n>Category</span>                     <span class=nb>object</span>
<span class=n>Current</span> <span class=n>Status</span>                           <span class=nb>object</span>
<span class=n>Status</span> <span class=n>at</span> <span class=n>Time</span> <span class=n>of</span> <span class=n>Lead</span>                   <span class=nb>object</span>
<span class=n>Original</span> <span class=n>Record</span><span class=p>:</span> <span class=n>Date</span> <span class=n>Created</span>    <span class=n>datetime64</span><span class=p>[</span><span class=n>ns</span><span class=p>]</span>
<span class=n>Date</span> <span class=n>Created</span>                     <span class=n>datetime64</span><span class=p>[</span><span class=n>ns</span><span class=p>]</span>
<span class=n>Inactive</span>                                 <span class=nb>object</span>
<span class=n>Specialty</span>                                <span class=nb>object</span>
<span class=n>Providers</span>                               <span class=n>float64</span>
<span class=n>duplicate_leads</span>                            <span class=nb>bool</span>
<span class=n>bad_leads</span>                                  <span class=nb>bool</span>
<span class=n>dtype</span><span class=p>:</span> <span class=nb>object</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=条件表达式的向量化></a><h3>条件表达式的向量化</h3><p>常规条件处理都是使用<code>if...else...</code>语句，将函数应用到<code>.apply</code>方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>set_lead_status</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>test</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>set_lead_status</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>8.15</span> <span class=n>s</span> <span class=err>±</span> <span class=mi>722</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>但是这种方法的执行速度非常慢，如果涉及数据量更大，那么无疑非常消耗时间。</p><a class=post-dummy-target id=npwhere></a><h3>np.where</h3><p><code>np.where</code>给定一个条件表达式，当条件表达式为真或假时返回对应的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># Pandas Series Vectorized baby!!</span>

<span class=c1># you can pass the output directly into a pandas Series</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span>   <span class=c1># &lt;-- condition</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span>                         <span class=c1># &lt;-- return if true</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span>                  <span class=c1># &lt;-- return if false</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>20.8</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>784</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.where` is {round((8.15 * 1000) / 20.8, 1)}x faster than `.apply`</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.where`</span> <span class=ow>is</span> <span class=mf>391.8</span><span class=n>x</span> <span class=n>faster</span> <span class=n>than</span> <span class=sb>`.apply`</span>
</code></pre></td></tr></table></div></div><p>直接使用<code>numpy</code>数组比<code>pandas.Series</code>的速度要快。在上述情况下，只需要处理<code>numpy</code>数组而无需处理<code>pandas.Series</code>的所有信息，因此要更快一些。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># NumPy Vectorized baby!!</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> 
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>9.59</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>310</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>100</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.where` w/ numpy vectorization is {round((8.15 * 1000) / 9.59, 1)}x faster than `.apply`</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.where`</span> <span class=n>w</span><span class=o>/</span> <span class=n>numpy</span> <span class=n>vectorization</span> <span class=ow>is</span> <span class=mf>849.8</span><span class=n>x</span> <span class=n>faster</span> <span class=n>than</span> <span class=sb>`.apply`</span>
</code></pre></td></tr></table></div></div><blockquote><p># %%timeit # test = df.apply(works_but_slow, axis=1, raw=True)</p><p>当使用 <code>raw=True</code>选项时，会显著改善<code>.apply</code>的速度。此选项可将numpy数组传递给自定义函数，从而代替<code>pd.Series</code>对象。</p></blockquote><p>但按照上述方法执行之后，耗时依然较长：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>8.55</span> <span class=n>s</span> <span class=err>±</span> <span class=mi>160</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=npvectorize></a><h3>np.vectorize</h3><p><code>np.vectorize</code>可以将python函数转换为<code>numpy ufunc</code>，可以处理向量化方法。可以向量化函数，而不需要应用到数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># Here is our previous function that I tried to vectorize but couldn&#39;t due to the ValueError. </span>
<span class=k>def</span> <span class=nf>works_fast_maybe</span><span class=p>(</span><span class=n>col1</span><span class=p>,</span> <span class=n>col2</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>col1</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>col2</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>col1</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># with the np.vectorize method --&gt; returns a vectorized callable</span>
<span class=n>vectfunc</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>vectorize</span><span class=p>(</span><span class=n>works_fast_maybe</span><span class=p>)</span> <span class=c1>#otypes=[np.float],cache=False)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>  <span class=n>test3</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>vectfunc</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>96</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>4.17</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>有人认为使用<strong>索引设置</strong>速度更快，但其实这不是向量化方式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>can_I_go_any_faster</span><span class=p>(</span><span class=n>status_at_time</span><span class=p>,</span> <span class=n>current_status</span><span class=p>)</span><span class=p>:</span>
    <span class=c1># this works fine if you&#39;re setting static values</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=c1># status_at_time</span>
    <span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>status_at_time</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_status</span>  <span class=c1># &lt;-- ValueError, indexes don&#39;t match!</span>
    <span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>status_at_time</span> <span class=o>!=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>status_at_time</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span> <span class=n>test4</span> <span class=o>=</span> <span class=n>can_I_go_any_faster</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>40.5</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>443</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>以下方法和上面的方法相差不大。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>can_I_go_any_faster2</span><span class=p>(</span><span class=n>status_at_time</span><span class=p>,</span> <span class=n>current_status</span><span class=p>)</span><span class=p>:</span>
    <span class=c1># this works fine if you&#39;re setting static values</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=c1># status_at_time</span>
    <span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>status_at_time</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>statys1_isNone</span><span class=s1>&#39;</span> 
    <span class=n>df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>status_at_time</span> <span class=o>!=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>test</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>statys2_notNone</span><span class=s1>&#39;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span> <span class=n>test5</span> <span class=o>=</span> <span class=n>can_I_go_any_faster2</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Status at Time of Lead</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Current Status</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>37.8</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>568</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=多条件处理></a><h3>多条件处理</h3><p>主要类别的选择</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>list1</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-3 Flame No Contact</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Campaign</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Claim</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Contact Program</span><span class=s1>&#39;</span><span class=p>,</span> 
         <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-General Pool</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-No Contact</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Nurture</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Unqualified</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PROSPECT-LOST</span><span class=s1>&#39;</span><span class=p>]</span>

<span class=n>list2</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>- None -</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Closed-Sold</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Handoff</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Implementation</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Implementation (EMR)</span><span class=s1>&#39;</span><span class=p>,</span>
         <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Live</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Partner</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Referring Consultant</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>CLIENT-Transferred</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Engaged</span><span class=s1>&#39;</span><span class=p>,</span> 
         <span class=sa></span><span class=s1>&#39;</span><span class=s1>LEAD-Long-Term Opportunity</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PROSPECT-CURRENT</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PROSPECT-LONG TERM</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PROSPECT-NO DECISION</span><span class=s1>&#39;</span><span class=p>]</span>

<span class=c1># apply version</span>
<span class=k>def</span> <span class=nf>lead_category</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>New Lead</span><span class=s1>&#39;</span>
    <span class=k>elif</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>CLI</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Client Lead</span><span class=s1>&#39;</span>
    <span class=k>elif</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span> <span class=ow>in</span> <span class=n>list1</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>MTouch Lead</span><span class=s1>&#39;</span>
    <span class=k>elif</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span> <span class=ow>in</span> <span class=n>list2</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>EMTouch Lead</span><span class=s1>&#39;</span>
    <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>NA</span><span class=s1>&#39;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_category0</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>lead_category</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>6.91</span> <span class=n>s</span> <span class=err>±</span> <span class=mf>91.4</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>当然也可以使用<code>np.where</code>实现上述功能，但是实现代码很难读。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_category</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> \
    <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>New Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
            <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>CLI</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Client Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
                    <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>list1</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>MTouch Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
                            <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>list2</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>EMTouch Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
                                     <span class=sa></span><span class=s1>&#39;</span><span class=s1>NA</span><span class=s1>&#39;</span><span class=p>)</span> 
                                  <span class=p>)</span>
                         <span class=p>)</span>
                <span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>96.7</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>2.17</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=npselect></a><h3>np.select</h3><p>对多个条件选择或嵌套条件而言，<code>np.select</code>的实现方法更简单甚至速度更快。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>conditions</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>CLI</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>list1</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>normalized_status</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span><span class=n>list2</span><span class=p>)</span><span class=o>.</span><span class=n>values</span>
<span class=p>]</span>

<span class=n>choices</span> <span class=o>=</span> <span class=p>[</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>New Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Client Lead</span><span class=s1>&#39;</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>MTouch Lead</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>EMTouch Lead</span><span class=s1>&#39;</span>
<span class=p>]</span>


<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_category1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>conditions</span><span class=p>,</span> <span class=n>choices</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>NA</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># Order of operations matter!</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>82.4</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>865</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p><code>np.select</code> 和 <code>np.where</code> 的输出结果是相同的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># Their output logic is the same</span>
<span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>lead_category</span> <span class=o>==</span> <span class=n>df</span><span class=o>.</span><span class=n>lead_category1</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=bp>True</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.select` w/ numpy vectorization is {round((6.9 * 1000) / 82.5, 2)} faster than nested .apply()</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.select`</span> <span class=n>w</span><span class=o>/</span> <span class=n>numpy</span> <span class=n>vectorization</span> <span class=ow>is</span> <span class=mf>83.64</span> <span class=n>faster</span> <span class=n>than</span> <span class=n>nested</span> <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.select` is {round(96.7 / 83.64, 2)} faster than nested `np.where`</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.select`</span> <span class=ow>is</span> <span class=mf>1.16</span> <span class=n>faster</span> <span class=n>than</span> <span class=n>nested</span> <span class=sb>`np.where`</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=向量化多条件表达式></a><h3>向量化多条件表达式</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># This is something you might think you can&#39;t vectorize, but you sure can!</span>
<span class=k>def</span> <span class=nf>sub_conditional</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_no_providers</span><span class=s1>&#39;</span>
        <span class=k>elif</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>:</span>
            <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_small</span><span class=s1>&#39;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_normal</span><span class=s1>&#39;</span>
    <span class=k>elif</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>duplicate_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>is_dup</span><span class=s1>&#39;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>bad_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>:</span>
            <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_bad</span><span class=s1>&#39;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_good</span><span class=s1>&#39;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># Let&#39;s time how long it takes to apply a nested multiple condition func</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_type</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>sub_conditional</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>5.72</span> <span class=n>s</span> <span class=err>±</span> <span class=mi>105</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>以下是利用<code>np.select</code>实现的多条件处理方法，速度有明显的提升。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>

<span class=c1># With np.select, could do .values here for additional speed, but left out to avoid too much text</span>
<span class=n>conditions</span> <span class=o>=</span> <span class=p>[</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=p>)</span><span class=p>,</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>)</span><span class=p>)</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>duplicate_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span>  <span class=c1># &lt;-- you can also just evaluate boolean arrays</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>bad_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span>
<span class=p>]</span>

<span class=n>choices</span> <span class=o>=</span> <span class=p>[</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_no_providers</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_small</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_normal</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>is_dup</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_bad</span><span class=s1>&#39;</span><span class=p>,</span>
<span class=p>]</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_type_vec</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>conditions</span><span class=p>,</span> <span class=n>choices</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>NA</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>61.1</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>1.3</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.select` is {round((5.82 * 1000) / 60.4, 2)} faster than nested .apply()</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.select`</span> <span class=ow>is</span> <span class=mf>96.36</span> <span class=n>faster</span> <span class=n>than</span> <span class=n>nested</span> <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>使用<code>np.select</code>时，直接获取原始数据可以进一步加速：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>

<span class=c1># With np.select</span>
<span class=n>conditions</span> <span class=o>=</span> <span class=p>[</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span><span class=p>)</span><span class=p>,</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>)</span><span class=p>)</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Inactive</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>No</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>duplicate_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>  <span class=c1># &lt;-- you can also just evaluate boolean arrays</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>bad_leads</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
<span class=p>]</span>

<span class=n>choices</span> <span class=o>=</span> <span class=p>[</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_no_providers</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_small</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_normal</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>is_dup</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>active_bad</span><span class=s1>&#39;</span><span class=p>,</span>
<span class=p>]</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_type_vec</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>conditions</span><span class=p>,</span> <span class=n>choices</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>NA</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>35.8</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>257</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=n>f</span><span class=sa></span><span class=s2>&#34;</span><span class=s2>`np.select` w/ vectorization is {round((5.72 * 1000) / 35.8, 2)} faster than nested .apply()</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=sb>`np.select`</span> <span class=n>w</span><span class=o>/</span> <span class=n>vectorization</span> <span class=ow>is</span> <span class=mf>159.78</span> <span class=n>faster</span> <span class=n>than</span> <span class=n>nested</span> <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=复杂示例></a><h3>复杂示例</h3><p>实际应用中可能会遇到各种各样的问题，下面展示一些其他情况示例：</p><a class=post-dummy-target id=字符串></a><h4>字符串</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=c1># Doing a regex search to find string patterns</span>

<span class=k>def</span> <span class=nf>find_paid_nonpaid</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>non.*?paid</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>I</span><span class=p>)</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>non-paid</span><span class=s1>&#39;</span>
    <span class=k>elif</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>Buyerzone|^paid</span><span class=s1>\</span><span class=s1>s+</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>I</span><span class=p>)</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>paid</span><span class=s1>&#39;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>unknown</span><span class=s1>&#39;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># our old friend .apply()</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_source_paid_unpaid</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>find_paid_nonpaid</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>480</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>12.4</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>那么如何使用<code>np.vectorize</code>进行向量化呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>

<span class=n>vect_str</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>vectorize</span><span class=p>(</span><span class=n>find_paid_nonpaid</span><span class=p>)</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_source_paid_unpaid1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vect_str</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>535</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>9.08</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># How does a list comprehension do?</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_source_paid_unpaid2</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>non-paid</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>non.*?paid</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>I</span><span class=p>)</span> 
                                  <span class=k>else</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>paid</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>Buyerzone|^paid</span><span class=s1>\</span><span class=s1>s+</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>I</span><span class=p>)</span> 
                                  <span class=k>else</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>unknown</span><span class=s1>&#39;</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>524</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>16.3</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p><code>pandas</code>提供了<code>.str</code>方法应用于字符串。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># How does this compare?</span>
<span class=n>conditions</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>non.*?paid</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>case</span><span class=o>=</span><span class=bp>False</span><span class=p>,</span> <span class=n>na</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;</span><span class=s1>Buyerzone|^paid</span><span class=s1>\</span><span class=s1>s+</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>case</span><span class=o>=</span><span class=bp>False</span><span class=p>,</span> <span class=n>na</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span><span class=p>,</span>
<span class=p>]</span>

<span class=n>choices</span> <span class=o>=</span> <span class=p>[</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>non-paid</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>paid</span><span class=s1>&#39;</span>
<span class=p>]</span>

<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lead_source_paid_unpaid1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>conditions</span><span class=p>,</span> <span class=n>choices</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>unknown</span><span class=s1>&#39;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>493</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>13.3</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>如果不搜索字符串效率会怎么样呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lowerls</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>lower</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mi>58</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>2.12</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>lowerls1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Lead Source</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>lower</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>69.9</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>1.78</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=字典查表></a><h4>字典查表</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>channel_dict</span> <span class=o>=</span> <span class=p>{</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Billing Service</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>BS</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Consultant</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Educational</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Enterprise</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Hospital</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>IPA</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>MBS</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>RCM</span><span class=s1>&#39;</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>MSO</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Medical practice</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Other</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Partner</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>PhyBillers</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>BS</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Practice</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Purchasing Group</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Reseller</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>BS</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Vendor</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>_Other</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>PD</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>RCM</span><span class=s1>&#39;</span><span class=p>:</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>RCM</span><span class=s1>&#39;</span>
<span class=p>}</span>

<span class=k>def</span> <span class=nf>a_dict_lookup</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>7</span><span class=p>:</span>
        <span class=k>return</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Upmarket</span><span class=s1>&#39;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>channel</span> <span class=o>=</span> <span class=n>channel_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Category</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>channel</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>a_dict_lookup</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>5.15</span> <span class=n>s</span> <span class=err>±</span> <span class=mf>58.4</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>&gt;</span> <span class=mi>7</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Upmarket</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Category</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>channel_dict</span><span class=p>)</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>17.5</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>144</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=p>(</span><span class=mf>5.15</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>/</span> <span class=mf>17.5</span> <span class=o>=</span> <span class=mf>294.2857142857143</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>channel_values</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Category</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>channel_dict</span><span class=p>)</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>7</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Upmarket</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>channel_values</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>19.6</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>452</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>100</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=c1># Using np.vectorize to vectorize a dictionary .get() method works, but is slower than .map()</span>
<span class=n>channel_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>vectorize</span><span class=p>(</span><span class=n>channel_dict</span><span class=o>.</span><span class=n>get</span><span class=p>)</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Category</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup2</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Providers</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>7</span><span class=p>,</span> 
    <span class=sa></span><span class=s1>&#39;</span><span class=s1>Upmarket</span><span class=s1>&#39;</span><span class=p>,</span>
    <span class=n>channel_values</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>37.7</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>730</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup1</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>
<span class=k>print</span><span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>dict_lookup2</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=p>)</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=bp>True</span>
<span class=bp>True</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=日期></a><h4>日期</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># make a new column called &#39;Start Date&#39; for dummy testing</span>
<span class=c1># ONly do a fraction so we have some NaN values</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>frac</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>weeks_to_complete</span><span class=p>(</span><span class=n>row</span><span class=p>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=nb>float</span><span class=p>:</span>
    <span class=sa></span><span class=s2>&#34;&#34;&#34;</span><span class=s2>Calculate the number of weeks between two dates</span><span class=s2>&#34;&#34;&#34;</span>
    <span class=k>if</span> <span class=n>pd</span><span class=o>.</span><span class=n>isnull</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>-</span>  <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>row</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>wtc1</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>weeks_to_complete</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>12.7</span> <span class=n>s</span> <span class=err>±</span> <span class=mi>115</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>1</span> <span class=n>loop</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>一个比较方便的向量化方法是使用<code>pandas</code>的<code>.dt</code>获取方法，其有很多便捷的方法/属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>wtc2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isnull</span><span class=p>(</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span><span class=p>,</span>
    <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>wtc2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isnull</span><span class=p>(</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span><span class=p>,</span>
    <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>days</span> <span class=o>/</span> <span class=mi>7</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>18.6</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>250</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>10</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>另一个方法是使用<code>ndarray</code>类型，即转换<code>series</code>为<code>numpy timedelta</code>数组。此方法更快，但是代码更冗余，涉及到一些基础的内容。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>wtc3</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isnull</span><span class=p>(</span><span class=p>)</span><span class=o>.</span><span class=n>values</span><span class=p>,</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>timedelta64[D]</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>timedelta64</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>D</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>)</span> <span class=o>/</span> <span class=mi>7</span><span class=p>,</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Start Date</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>timedelta64[D]</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>timedelta64</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>D</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>)</span> <span class=o>/</span> <span class=mi>7</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>7.91</span> <span class=n>ms</span> <span class=err>±</span> <span class=mi>113</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>100</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=c1># How much faster is our last way over .apply()?</span>
<span class=p>(</span><span class=mf>12.7</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>/</span> <span class=mf>7.91</span> <span class=o>=</span> <span class=mf>1605.5625790139063</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=逻辑表达式所需要的值在其他行></a><h4>逻辑表达式所需要的值在其他行</h4><p>此任务主要是想实现<code>Excel</code>中的函数：</p><p><code>=IF(A2=A1, IF(L2-L1 &lt; 5, 0, 1), 1))</code></p><p><code>A</code>列表示<code>id</code>，<code>L</code>列表示日期。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python> <span class=k>def</span> <span class=nf>time_looper</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=p>:</span>
    <span class=sa></span><span class=s2>&#34;&#34;&#34;</span><span class=s2> Using a plain Python for loop</span><span class=s2>&#34;&#34;&#34;</span>
    <span class=n>output</span> <span class=o>=</span> <span class=p>[</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=p>)</span><span class=p>)</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            
            <span class=c1># compare the current id to the row above</span>
            <span class=k>if</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>:</span>
                
                <span class=c1># compare the current date to the row above</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>:</span>
                    <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>output</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>time_looper2</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=p>:</span>
    <span class=sa></span><span class=s2>&#34;&#34;&#34;</span><span class=s2>Using pandas dataframe `.iterrows()` method for iterating over rows</span><span class=s2>&#34;&#34;&#34;</span>
    <span class=n>output</span> <span class=o>=</span> <span class=p>[</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>(</span><span class=p>)</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>:</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>days</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>:</span>
                    <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>nan</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>output</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>df</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>time</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>time_col_raw_for</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>time_looper</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>CPU</span> <span class=n>times</span><span class=p>:</span> <span class=n>user</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>1</span><span class=n>s</span><span class=p>,</span> <span class=n>sys</span><span class=p>:</span> <span class=mf>7.17</span> <span class=n>ms</span><span class=p>,</span> <span class=n>total</span><span class=p>:</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>1</span><span class=n>s</span>
<span class=n>Wall</span> <span class=n>time</span><span class=p>:</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>1</span><span class=n>s</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>time</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>time_col_iterrows</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>time_looper2</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>CPU</span> <span class=n>times</span><span class=p>:</span> <span class=n>user</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>19</span><span class=n>s</span><span class=p>,</span> <span class=n>sys</span><span class=p>:</span> <span class=mf>67.5</span> <span class=n>ms</span><span class=p>,</span> <span class=n>total</span><span class=p>:</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>19</span><span class=n>s</span>
<span class=n>Wall</span> <span class=n>time</span><span class=p>:</span> <span class=mi>2</span><span class=nb>min</span> <span class=mi>19</span><span class=n>s</span>
</code></pre></td></tr></table></div></div><p>我们按照如下方法进行向量化：</p><ul><li>使用<code>pandas.shift</code>函数，将之前的值向下移动，这样就可以对比相同轴上的值</li><li>使用<code>np.select</code>向量化条件逻辑检查</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=o>%</span><span class=o>%</span><span class=n>timeit</span>
<span class=n>previous_id</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
<span class=n>previous_date</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Original Record: Date Created</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>1900</span><span class=s1>&#39;</span><span class=p>)</span><span class=p>)</span>

<span class=n>conditions</span> <span class=o>=</span> <span class=p>[</span>
    <span class=p>(</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span>  <span class=n>previous_id</span><span class=p>)</span> <span class=o>&amp;</span> 
     <span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Date Created</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>previous_date</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>timedelta64[D]</span><span class=s1>&#39;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>5</span><span class=p>)</span><span class=p>,</span>
    <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Internal ID</span><span class=s1>&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span> <span class=o>==</span>  <span class=n>previous_id</span>
<span class=p>]</span>
<span class=n>choices</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
<span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>time_col1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=n>conditions</span><span class=p>,</span> <span class=n>choices</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=mf>11.1</span> <span class=n>ms</span> <span class=err>±</span> <span class=mf>49.3</span> <span class=err>µ</span><span class=n>s</span> <span class=n>per</span> <span class=n>loop</span> <span class=p>(</span><span class=n>mean</span> <span class=err>±</span> <span class=n>std</span><span class=o>.</span> <span class=n>dev</span><span class=o>.</span> <span class=n>of</span> <span class=mi>7</span> <span class=n>runs</span><span class=p>,</span> <span class=mi>100</span> <span class=n>loops</span> <span class=n>each</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=p>(</span><span class=p>(</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span> <span class=o>+</span> <span class=mi>19</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>/</span> <span class=mf>11.1</span> <span class=o>=</span> <span class=mf>12522.522522522522</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>time_col1</span><span class=s1>&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>df</span><span class=p>[</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>time_col_iterrows</span><span class=s1>&#39;</span><span class=p>]</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=bp>False</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=其他方法></a><h3>其他方法</h3><a class=post-dummy-target id=并行函数></a><h4>并行函数</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>multiprocessing</span> <span class=kn>import</span> <span class=n>Pool</span>

<span class=k>def</span> <span class=nf>p_apply</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=n>cores</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span><span class=p>:</span>
    <span class=sa></span><span class=s2>&#34;&#34;&#34;</span><span class=s2>Pass in your dataframe and the func to apply to it</span><span class=s2>&#34;&#34;&#34;</span>
    <span class=n>df_split</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array_split</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>cores</span><span class=p>)</span>
    <span class=n>pool</span> <span class=o>=</span> <span class=n>Pool</span><span class=p>(</span><span class=n>n_cores</span><span class=p>)</span>
    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>pool</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>func</span><span class=p>,</span> <span class=n>df_split</span><span class=p>)</span><span class=p>)</span>
    <span class=n>pool</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=p>)</span>
    <span class=n>pool</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>df</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>df</span> <span class=o>=</span> <span class=n>p_apply</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>func</span><span class=o>=</span><span class=n>some_big_function</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=参考链接></a><h3>参考链接：</h3><ol><li><a href=https://gitlab.com/cheevahagadog/talks-demos-n-such/blob/master/PyGotham2019/PyGotham-updated.ipynb>https://gitlab.com/cheevahagadog/talks-demos-n-such/blob/master/PyGotham2019/PyGotham-updated.ipynb</a></li><li><a href=https://stackoverflow.com/questions/52673285/performance-of-pandas-apply-vs-np-vectorize-to-create-new-column-from-existing-c>https://stackoverflow.com/questions/52673285/performance-of-pandas-apply-vs-np-vectorize-to-create-new-column-from-existing-c</a></li><li><a href=https://docs.scipy.org/doc/numpy/reference/generated/numpy.vectorize.html>https://docs.scipy.org/doc/numpy/reference/generated/numpy.vectorize.html</a></li><li><a href=https://www.experfy.com/blog/why-you-should-forget-loops-and-embrace-vectorization-for-data-science>https://www.experfy.com/blog/why-you-should-forget-loops-and-embrace-vectorization-for-data-science</a></li></ol></div><div class=post-footer id=post-footer><div style="padding:10px 0;margin:20px auto;width:100%;font-size:16px;text-align:center"><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>打赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=/img/Wechat.jpeg alt="WeChat Pay"></a><p>微信打赏</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=/img/Alipay.jpeg alt=Alipay></a><p>支付宝打赏</p></div></div></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2020-01-28</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25A4%2584%25E7%2590%2586%25E9%2580%259F%25E5%25BA%25A6%25E6%258F%2590%25E5%258D%25871000-%25E5%2580%258D%2f&text=%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e9%80%9f%e5%ba%a6%e6%8f%90%e5%8d%871000%2b%e5%80%8d&via=xxxx" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25A4%2584%25E7%2590%2586%25E9%2580%259F%25E5%25BA%25A6%25E6%258F%2590%25E5%258D%25871000-%25E5%2580%258D%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25A4%2584%25E7%2590%2586%25E9%2580%259F%25E5%25BA%25A6%25E6%258F%2590%25E5%258D%25871000-%25E5%2580%258D%2f&title=%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e9%80%9f%e5%ba%a6%e6%8f%90%e5%8d%871000%2b%e5%80%8d" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//service.weibo.com/share/share.php?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E6%2595%25B0%25E6%258D%25AE%25E5%25A4%2584%25E7%2590%2586%25E9%2580%259F%25E5%25BA%25A6%25E6%258F%2590%25E5%258D%25871000-%25E5%2580%258D%2f&appkey=&title=%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e9%80%9f%e5%ba%a6%e6%8f%90%e5%8d%871000%2b%e5%80%8d&pic=%2fimg%2fpandas.jpeg" target=_blank title="Share on Weibo"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://atmosai.github.io/tags/python/><i class="fas fa-tag fa-fw"></i>&nbsp;python</a>&nbsp;
</span><span class=tag><a href=https://atmosai.github.io/tags/pandas/><i class="fas fa-tag fa-fw"></i>&nbsp;pandas</a>&nbsp;
</span><span class=tag><a href=https://atmosai.github.io/tags/numpy/><i class="fas fa-tag fa-fw"></i>&nbsp;numpy</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://atmosai.github.io>Home</a></span></section></div><div class=post-nav><a href=https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/ class=prev rel=prev title=提高matplotlib的出图效率><i class="fas fa-angle-left fa-fw"></i>提高matplotlib的出图效率</a></div></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://atmosai.github.io target=_blank>bugsuse</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span>
</a><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></body></html>