<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>记一次非常奇怪的WRF-CMAQ错误 | bugsuse</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="About LoveIt Theme"><link rel=prev href=https://atmosai.github.io/2019/12/cpython%E5%8A%A0%E5%AF%86python%E4%BB%A3%E7%A0%81/><link rel=next href=https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/><link rel=canonical href=https://atmosai.github.io/2020/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="记一次非常奇怪的WRF-CMAQ错误"><meta property="og:description" content="近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了Segmentation Fault 的问题， 当时 namelist.input 中设置如下： 1 sf_surface_physics"><meta property="og:type" content="article"><meta property="og:url" content="https://atmosai.github.io/2020/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF/"><meta property="article:published_time" content="2020-01-13T16:21:27+08:00"><meta property="article:modified_time" content="2020-01-13T16:21:27+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="记一次非常奇怪的WRF-CMAQ错误"><meta name=twitter:description content="近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了Segmentation Fault 的问题， 当时 namelist.input 中设置如下： 1 sf_surface_physics"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"记一次非常奇怪的WRF-CMAQ错误","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/atmosai.github.io\/2020\/01\/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF\/"},"image":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"WRF, CMAQ","wordcount":846,"url":"https:\/\/atmosai.github.io\/2020\/01\/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF\/","datePublished":"2020-01-13T16:21:27\x2b08:00","dateModified":"2020-01-13T16:21:27\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=navbar-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a class=menu-item href=http://i-lightning.com title=简体中文><i class="fas fa-language fa-fw"></i></a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a class=menu-item href=http://i-lightning.com title=简体中文></a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">记一次非常奇怪的WRF-CMAQ错误</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://i-lightning.cn rel=author target=_blank><i class="fas fa-user-circle fa-fw"></i>bugsuse
</a>&nbsp;<span class=post-category>included in&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://atmosai.github.io/categories/model/>Model</a>&nbsp;</span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-01-13>2020-01-13</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 846 words&nbsp;
<i class="far fa-clock fa-fw"></i>2 min&nbsp;</div></div><div class=post-featured-image><img src=/svg/loading.min.svg data-sizes=auto data-src=/img/wrf-cmaq.png alt="featured image" class=lazyload></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#问题排查>问题排查</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#问题排查>问题排查</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>近期在准备搭建一套WRF-CMAQ空气质量预报系统，从准备WRF模式运行开始就出现了<code>Segmentation Fault </code>的问题，</p><p>当时 <code>namelist.input</code> 中设置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>sf_surface_physics     = 2, 2, 2
</code></pre></td></tr></table></div></div><p>后改为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>sf_surface_physics     = 1, 1, 1
</code></pre></td></tr></table></div></div><p>WRF模式能够正常运行，<strong>猜测可能是陆面方案的问题</strong>。</p><p>本来以为WRF模式正常之后就可以，结果到运行MCIP/CMAQ，计算<strong>干沉降速率</strong>的时候也报错了！！都是出现类似以下错误信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback> **********************************************************************
 *** SUBROUTINE: M3DRY
 ***   NEGATIVE OR UNDEFINED DRY DEPOSITION VELOCITY
 ***   POINT   =    90   57
 ***   SPECIES = SO2
 ***   Vd      =           NaN
 **********************************************************************
</code></pre></td></tr></table></div></div><p>在运行MCIP时还可以通过更改干沉降速率的选项关闭干沉降速率计算解决此问题，但在运行CCTM时似乎没有提供此选项。只能排查出现此错误的原因了。</p><blockquote><p>Numerical problems can occur in these algorithms because the WRF model input has LAI=0 for grids located over the ocean or in ice-bound regions. The m3dry.F algorithm includes divide-by-LAI without protection for LAI being zero. This can cause the program to generate Inf or NaN values.
The most recent version of MCIP (3.6) includes a correction for this problem: the MCIP file m3dry.F includes separate calculations for land and water, and the solution for water is used whenever vegetation (xveg) is zero. This appears to cover all occurrences of zero LAI. However the CMAQ algorithm still uses solutions that cannot handle zero LAI and are not bypassed.
The inline m3dry.F for bidirectional Hg also includes a call to a numerical solver (ATX) for soil concentrations with control statements that call for the solution for land grids only. (A separate solution is provided for grids representing water.) The solution for soil concentrations can fail to converge or generate negative values if leaf area index and other soil parameters are zero or near-zero. Normally, LAI is 0.1 or higher for land grids. However the WRF output includes a small number of grids that are flagged as &lsquo;land&rsquo; grids even though LAI = 0 and the soil type category is &lsquo;water&rsquo;. (These have been found for grids at the southern end of Hudsons Bay in Canada.)</p></blockquote><p>回到MCIP，检查上述错误出现在<code>m3dry.ff90</code> 中，定位到计算干沉降速率的地方，发现是部分区域的<code>canopy wetness</code> 值为0导致计算过程中出现了<code>NaN</code>，下面一行是排查时输出结果，最后一个是 <code>xlai(90, 57)</code>的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>          90          57  2.1474836E+09  0.0000000E+00  0.0000000E+00
</code></pre></td></tr></table></div></div><p>说明WRF模式的结果中关于陆面的变量有问题，联系到之前运行WRF模式陆面方案存在问题，怀疑两者可能存在联系。最终还是回到WRF模式。</p><a class=post-dummy-target id=问题排查></a><h3>问题排查</h3><p>重新选择<code>Noah</code>方案检查错误</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>sf_surface_physics     = 2, 2, 2
</code></pre></td></tr></table></div></div><p>通过检查<code>rsl.out*</code> 输出内容发现错误信息如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Flerchinger USEd in NEW version. Iterations= 10
</code></pre></td></tr></table></div></div><p>通过搜索发现可能是<code>wrfinput_d0*</code> 文件中的<code>SH2O</code>或<code>SMOIS</code> 变量存在0或负值导致。然后检查这两个变量值发现，<code>SMOIS</code> 中部分区域的值为0。然后更改了<code>Vtable</code>文件，重新运行WPS和WRF模式，结果一切正常，问题解决！</p><p>​</p><a class=post-dummy-target id=参考链接></a><h3>参考链接</h3><ol><li><a href="http://forum.wrfforum.com/viewtopic.php?f=6&t=2531">http://forum.wrfforum.com/viewtopic.php?f=6&t=2531</a></li><li><a href=http://blog.sina.com.cn/s/blog_3eac55fd0101748w.html>http://blog.sina.com.cn/s/blog_3eac55fd0101748w.html</a></li><li><a href=http://www-personal.umich.edu/~sillman/CMAQ_corrections_2010.htm>http://www-personal.umich.edu/~sillman/CMAQ_corrections_2010.htm</a></li><li><a href="http://bbs.06climate.com/forum.php?mod=viewthread&tid=88671">http://bbs.06climate.com/forum.php?mod=viewthread&tid=88671</a></li></ol></div><div class=post-footer id=post-footer><div style="padding:10px 0;margin:20px auto;width:100%;font-size:16px;text-align:center"><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>打赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=/img/Wechat.jpeg alt="WeChat Pay"></a><p>微信打赏</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=/img/Alipay.jpeg alt=Alipay></a><p>支付宝打赏</p></div></div></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2020-01-13</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E8%25AE%25B0%25E4%25B8%2580%25E6%25AC%25A1%25E9%259D%259E%25E5%25B8%25B8%25E5%25A5%2587%25E6%2580%25AA%25E7%259A%2584wrf-cmaq%25E9%2594%2599%25E8%25AF%25AF%2f&text=%e8%ae%b0%e4%b8%80%e6%ac%a1%e9%9d%9e%e5%b8%b8%e5%a5%87%e6%80%aa%e7%9a%84WRF-CMAQ%e9%94%99%e8%af%af&via=xxxx" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E8%25AE%25B0%25E4%25B8%2580%25E6%25AC%25A1%25E9%259D%259E%25E5%25B8%25B8%25E5%25A5%2587%25E6%2580%25AA%25E7%259A%2584wrf-cmaq%25E9%2594%2599%25E8%25AF%25AF%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E8%25AE%25B0%25E4%25B8%2580%25E6%25AC%25A1%25E9%259D%259E%25E5%25B8%25B8%25E5%25A5%2587%25E6%2580%25AA%25E7%259A%2584wrf-cmaq%25E9%2594%2599%25E8%25AF%25AF%2f&title=%e8%ae%b0%e4%b8%80%e6%ac%a1%e9%9d%9e%e5%b8%b8%e5%a5%87%e6%80%aa%e7%9a%84WRF-CMAQ%e9%94%99%e8%af%af" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//service.weibo.com/share/share.php?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2f%25E8%25AE%25B0%25E4%25B8%2580%25E6%25AC%25A1%25E9%259D%259E%25E5%25B8%25B8%25E5%25A5%2587%25E6%2580%25AA%25E7%259A%2584wrf-cmaq%25E9%2594%2599%25E8%25AF%25AF%2f&appkey=&title=%e8%ae%b0%e4%b8%80%e6%ac%a1%e9%9d%9e%e5%b8%b8%e5%a5%87%e6%80%aa%e7%9a%84WRF-CMAQ%e9%94%99%e8%af%af&pic=%2fimg%2fwrf-cmaq.png" target=_blank title="Share on Weibo"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://atmosai.github.io/tags/wrf/><i class="fas fa-tag fa-fw"></i>&nbsp;WRF</a>&nbsp;
</span><span class=tag><a href=https://atmosai.github.io/tags/cmaq/><i class="fas fa-tag fa-fw"></i>&nbsp;CMAQ</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://atmosai.github.io>Home</a></span></section></div><div class=post-nav><a href=https://atmosai.github.io/2019/12/cpython%E5%8A%A0%E5%AF%86python%E4%BB%A3%E7%A0%81/ class=prev rel=prev title=Cpython加密python代码><i class="fas fa-angle-left fa-fw"></i>Cpython加密python代码</a>
<a href=https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/ class=next rel=next title=提高matplotlib的出图效率>提高matplotlib的出图效率<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="i-lightning-cn";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://atmosai.github.io target=_blank>bugsuse</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-112932643-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></body></html>