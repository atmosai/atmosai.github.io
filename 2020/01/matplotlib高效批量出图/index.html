<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>提高matplotlib的出图效率 | bugsuse</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="matplotlib"><link rel=prev href=https://atmosai.github.io/2020/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF/><link rel=next href=https://atmosai.github.io/2020/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D/><link rel=canonical href=https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/><link rel="shortcut icon" type=image/x-icon href=/img/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=manifest href=/img/site.webmanifest><link rel=mask-icon href=/img/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="提高matplotlib的出图效率"><meta property="og:description" content="matplotlib"><meta property="og:type" content="article"><meta property="og:url" content="https://atmosai.github.io/2020/01/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE/"><meta property="article:published_time" content="2020-01-27T16:59:09+08:00"><meta property="article:modified_time" content="2020-01-27T16:59:09+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="提高matplotlib的出图效率"><meta name=twitter:description content="matplotlib"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"提高matplotlib的出图效率","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/atmosai.github.io\/2020\/01\/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE\/"},"image":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"matplotlib","wordcount":2053,"url":"https:\/\/atmosai.github.io\/2020\/01\/matplotlib%E9%AB%98%E6%95%88%E6%89%B9%E9%87%8F%E5%87%BA%E5%9B%BE\/","datePublished":"2020-01-27T16:59:09\x2b08:00","dateModified":"2020-01-27T16:59:09\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"bugsuse","logo":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/img\/res.png","width":127,"height":40}},"description":"matplotlib"}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=navbar-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/friends>Friends</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/friends>Friends</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">提高matplotlib的出图效率</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://i-lightning.cn rel=author target=_blank><i class="fas fa-user-circle fa-fw"></i>bugsuse
</a>&nbsp;<span class=post-category>included in&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://atmosai.github.io/categories/tools/>Tools</a>&nbsp;</span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-01-27>2020-01-27</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 2053 words&nbsp;
<i class="far fa-clock fa-fw"></i>5 min&nbsp;</div></div><div class=post-featured-image><img src=/svg/loading.min.svg data-sizes=auto data-src=/img/matplotlib2.jpg alt="featured image" class=lazyload></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#多进程>多进程</a></li><li><a href=#图形渲染>图形渲染</a><ul><li><a href=#删除图层操作>删除图层操作</a></li><li><a href=#线或者文本操作>线或者文本操作</a></li></ul></li><li><a href=#测试对比>测试对比</a><ul><li><a href=#单核对比>单核对比</a></li><li><a href=#多核对比>多核对比</a></li></ul></li><li><a href=#注意事项>注意事项</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#多进程>多进程</a></li><li><a href=#图形渲染>图形渲染</a><ul><li><a href=#删除图层操作>删除图层操作</a></li><li><a href=#线或者文本操作>线或者文本操作</a></li></ul></li><li><a href=#测试对比>测试对比</a><ul><li><a href=#单核对比>单核对比</a></li><li><a href=#多核对比>多核对比</a></li></ul></li><li><a href=#注意事项>注意事项</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>在数值预报后处理中经常需要批量出图，而基于matplotlib的图形渲染速度较慢，而提高出图的速度通常可通过两个方面来解决:</p><ul><li>多进程进行绘图</li><li>图形渲染调整</li></ul><a class=post-dummy-target id=多进程></a><h3>多进程</h3><p>在python中使用多进程方法加速批量出图是非常方便的。但这需要电脑有多个核，当然对于现代电脑和服务器而言已经不再是问题。</p><p>可选择<code>deco</code>和<code>multiprocessing</code>工具解决此问题。<code>deco</code>是对<code>multiprocessing</code>的封装，使用更加简单方便。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>deco</span> <span class=kn>import</span> <span class=o>*</span>

<span class=nd>@concurrent</span><span class=p>(</span><span class=n>processes</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span> <span class=c1># We add this for the concurrent function</span>
<span class=k>def</span> <span class=nf>process_lat_lon</span><span class=p>(</span><span class=n>lat</span><span class=p>,</span> <span class=n>lon</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span><span class=p>:</span>
  <span class=c1>#Does some work which takes a while</span>
  <span class=k>return</span> <span class=n>result</span>

<span class=nd>@synchronized</span> <span class=c1># And we add this for the function which calls the concurrent function</span>
<span class=k>def</span> <span class=nf>process_data_set</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=p>:</span>
  <span class=n>results</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>lat</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>.</span><span class=o>.</span><span class=o>.</span><span class=p>)</span><span class=p>:</span>
    <span class=k>for</span> <span class=n>lon</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>.</span><span class=o>.</span><span class=o>.</span><span class=p>)</span><span class=p>:</span>
      <span class=n>results</span><span class=p>[</span><span class=n>lat</span><span class=p>]</span><span class=p>[</span><span class=n>lon</span><span class=p>]</span> <span class=o>=</span> <span class=n>process_lat_lon</span><span class=p>(</span><span class=n>lat</span><span class=p>,</span> <span class=n>lon</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
  <span class=k>return</span> <span class=n>results</span>
</code></pre></td></tr></table></div></div><p>第一个函数使用装饰器<code>@concurrent</code>，第二个函数使用了装饰器<code>@synchronized</code>，第二个函数中调用了第一个函数。第二个函数的装饰器是可选的，但最好使用装饰器进行封装。</p><p>第一个装饰器中给定了一个参数<code>processes</code>：表示进程数，如果没有给定，则使用所有的cpu。</p><a class=post-dummy-target id=图形渲染></a><h3>图形渲染</h3><p>以数值预报模式的批量出图过程中的气象要素空间分布为例。气象要素的空间分布必然涉及到地理信息的处理，比如添加海岸线、省市边界线、江流河海等。对于空间分布图而言，上述的地理信息是不变的。因此在批量出图时，相同地理范围的图可以使用相同的背景图。以温度的空间分布为例，这里所说的背景图是除了温度的空间分布外的海岸线、省市边界线、轴的标注等信息。</p><p>在绘图的时候都是按照图层进行先后叠加的，而叠加后的图层是可以删除的。批量出图时只需要将会变的信息清空，然后在背景图上叠加新的信息即可。这样，就能节省绘制地图的时间，每次只需要绘制一次地图即可。想想如果需要批量生成的图数量很多的话，这样就能节省很多时间。</p><a class=post-dummy-target id=删除图层操作></a><h4>删除图层操作</h4><p>对于<code>matplotlib.contour</code>类函数而言，删除操作如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>con</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>contourf</span><span class=p>(</span><span class=n>lon</span><span class=p>,</span> <span class=n>lat</span><span class=p>,</span> <span class=n>temp</span><span class=p>)</span>

<span class=k>for</span> <span class=n>coll</span> <span class=ow>in</span> <span class=n>con</span><span class=o>.</span><span class=n>collections</span><span class=p>:</span>
    <span class=n>coll</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=线或者文本操作></a><h4>线或者文本操作</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>lines</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>

<span class=n>l</span> <span class=o>=</span> <span class=n>lines</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>l</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>对于文本操作而言，以设置标题为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>at</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa></span><span class=s1>&#39;</span><span class=s1>Test</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>at</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>会出现以下错误信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=ne>NotImplementedError</span><span class=p>:</span> <span class=n>cannot</span> <span class=n>remove</span> <span class=n>artist</span>
</code></pre></td></tr></table></div></div><p>搜索了很久没找到解决办法，也就没有尝试。</p><p>但可以通过更新文本的方式覆盖原先的文本信息，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>ax</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=bp>None</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>这样就能解决上述问题了。当然也可以使用如下方式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>ax</span><span class=o>.</span><span class=n>set_visible</span><span class=p>(</span><span class=bp>False</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=测试对比></a><h3>测试对比</h3><p>整个循环批量出图需要对9个变量，输出4725张图。以下性能测试分析仅选取一个变量，绘制7张图。</p><a class=post-dummy-target id=单核对比></a><h4>单核对比</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>time</span> kernprof -l plot.py
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>real	0m31.441s
user	1m22.964s
sys	0m1.092s
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> Line <span class=c1>#      Hits         Time  Per Hit   % Time  Line Contents</span>
 <span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span><span class=o>=</span>
     <span class=m>63</span>         <span class=m>7</span>     250148.0  35735.4      0.8      fig, <span class=nv>ax</span> <span class=o>=</span> plt.subplots<span class=o>(</span><span class=nv>figsize</span><span class=o>=</span><span class=o>(</span>12, 9<span class=o>)</span><span class=o>)</span>
     <span class=m>64</span>         <span class=m>7</span>        273.0     39.0      0.0      <span class=nv>m</span> <span class=o>=</span> Basemap<span class=o>(</span><span class=nv>llcrnrlon</span><span class=o>=</span>lon<span class=o>[</span>0,0<span class=o>]</span>, <span class=nv>llcrnrlat</span><span class=o>=</span>lat<span class=o>[</span>0,0<span class=o>]</span>,
     <span class=m>65</span>         <span class=m>7</span>        163.0     23.3      0.0                  <span class=nv>urcrnrlon</span><span class=o>=</span>lon<span class=o>[</span>-1,-1<span class=o>]</span>, <span class=nv>urcrnrlat</span><span class=o>=</span>lat<span class=o>[</span>-1,-1<span class=o>]</span>,
     <span class=m>66</span>         <span class=m>7</span>         14.0      2.0      0.0                  <span class=nv>projection</span><span class=o>=</span><span class=s1>&#39;lcc&#39;</span>, <span class=nv>resolution</span><span class=o>=</span><span class=s1>&#39;l&#39;</span>,
     <span class=m>67</span>         <span class=m>7</span>         15.0      2.1      0.0                  <span class=nv>lat_1</span><span class=o>=</span>30, <span class=nv>lat_2</span><span class=o>=</span>60,
     <span class=m>68</span>         <span class=m>7</span>   15828248.0 2261178.3     52.2                  <span class=nv>lat_0</span><span class=o>=</span>33.5, <span class=nv>lon_0</span><span class=o>=</span>106<span class=o>)</span>
     <span class=m>69</span>         <span class=m>7</span>         43.0      6.1      0.0      <span class=nv>shp</span> <span class=o>=</span> m.readshapefile<span class=o>(</span><span class=s1>&#39;shps/cnhimap&#39;</span>, <span class=s1>&#39;china&#39;</span>,
     <span class=m>70</span>         <span class=m>7</span>    3270262.0 467180.3     10.8                    <span class=nv>linewidth</span><span class=o>=</span>1.5, <span class=nv>color</span><span class=o>=</span><span class=s1>&#39;k&#39;</span>, <span class=nv>ax</span><span class=o>=</span>ax<span class=o>)</span>
     <span class=m>71</span>         <span class=m>7</span>         28.0      4.0      0.0      <span class=nv>hb</span>  <span class=o>=</span> m.readshapefile<span class=o>(</span><span class=s1>&#39;shps/hb&#39;</span>, <span class=s1>&#39;hebei&#39;</span>,
     <span class=m>72</span>         <span class=m>7</span>     348692.0  49813.1      1.1                            <span class=nv>linewidth</span><span class=o>=</span>1.5, <span class=nv>color</span><span class=o>=</span><span class=s1>&#39;blue&#39;</span>, <span class=nv>ax</span><span class=o>=</span>ax<span class=o>)</span>
     <span class=m>73</span>         <span class=m>7</span>      55085.0   7869.3      0.2      x, <span class=nv>y</span> <span class=o>=</span> m<span class=o>(</span>lon, lat<span class=o>)</span>
     <span class=m>74</span>
     <span class=m>75</span>         <span class=m>7</span>        107.0     15.3      0.0      <span class=nv>con</span> <span class=o>=</span> m.contourf<span class=o>(</span>x, y, aqid, np.arange<span class=o>(</span>rangs<span class=o>[</span>0<span class=o>]</span>, rangs<span class=o>[</span>-1<span class=o>]</span>+1, 1<span class=o>)</span>,
     <span class=m>76</span>         <span class=m>7</span>         16.0      2.3      0.0                       <span class=nv>vmin</span><span class=o>=</span>rangs<span class=o>[</span>0<span class=o>]</span>, <span class=nv>vmax</span><span class=o>=</span>rangs<span class=o>[</span>-1<span class=o>]</span>, <span class=nv>norm</span><span class=o>=</span>aqi_norm,
     <span class=m>77</span>         <span class=m>7</span>    2528715.0 361245.0      8.3                       <span class=nv>cmap</span><span class=o>=</span>aqi_cmap, <span class=nv>extend</span><span class=o>=</span>extend, <span class=nv>ax</span><span class=o>=</span>ax<span class=o>)</span>
     <span class=m>78</span>
     <span class=m>79</span>         <span class=m>7</span>         29.0      4.1      0.0      m.drawparallels<span class=o>(</span>yticks, <span class=nv>labels</span><span class=o>=</span><span class=o>[</span>1,0,0,0<span class=o>]</span>, <span class=nv>linewidth</span><span class=o>=</span>0.5,
     <span class=m>80</span>         <span class=m>7</span>     464004.0  66286.3      1.5                      <span class=nv>ax</span><span class=o>=</span>ax, <span class=nv>fmt</span><span class=o>=</span>lat2str, <span class=nv>fontdict</span><span class=o>=</span>dict<span class=o>(</span><span class=nv>fontsize</span><span class=o>=</span>FT<span class=o>)</span><span class=o>)</span>
     <span class=m>81</span>         <span class=m>7</span>         25.0      3.6      0.0      m.drawmeridians<span class=o>(</span>xticks, <span class=nv>labels</span><span class=o>=</span><span class=o>[</span>0,0,0,1<span class=o>]</span>, <span class=nv>linewidth</span><span class=o>=</span>0.5,
     <span class=m>82</span>         <span class=m>7</span>     317093.0  45299.0      1.0                      <span class=nv>ax</span><span class=o>=</span>ax, <span class=nv>fmt</span><span class=o>=</span>lon2str, <span class=nv>fontdict</span><span class=o>=</span>dict<span class=o>(</span><span class=nv>fontsize</span><span class=o>=</span>FT<span class=o>)</span><span class=o>)</span>
     <span class=m>83</span>         <span class=m>7</span>      23429.0   3347.0      0.1      m.drawcoastlines<span class=o>(</span><span class=o>)</span>
</code></pre></td></tr></table></div></div><p>通过性能分析结果可以看出：</p><p><strong>创建 map 占据了超过一半的时间，占比52.2%，而添加地图边界占比11.9%，添加轴标注占比2.5%。而这些都属于背景图的信息，只需要创建一次即可。</strong></p><p>将背景图信息的部分单独拿出来，只创建一次，每次在背景图上添加新图层，新的图存储后将添加的图层删除，然后重复利用。</p><p>以下是优化后代码的执行结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>time</span> kernprof -l plot_eff.py
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>real	0m14.141s
user	0m21.010s
sys	0m0.670s
</code></pre></td></tr></table></div></div><p>相比于之前运行的<code>31s</code>，优化后的代码运行时间只有<code>14s</code>，速度提升了超过50%。</p><a class=post-dummy-target id=多核对比></a><h4>多核对比</h4><p>多核并行运行采用<code>deco</code>工具，使用3个核进行测试。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>time</span> python plot.py
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>real	0m11.224s
user	0m55.686s
sys	0m1.610s
</code></pre></td></tr></table></div></div><p>测试单背景图的多核时出现了问题，<code>figure.canvas</code> 为 <code>NoneType</code>，导致出错：<code>AttributeError: 'NoneType' object has no attribute 'print_figure'</code></p><p>猜测可能是只创建了一个<code>figure</code>对象，导致在使用多进程传递对象时出现了混乱，从而导致出现问题。而后对代码进行了改进，仅将创建<code>map</code>的代码放到了循环之外，只创建一次地图。毕竟创建地图的代码的时间占比就超过了50%，其余部分占比较低，改动此项仍能大幅节省画图时间。</p><p>以下是改进后的3个核的运行效率，相比于原始脚本而言，仍然提升了35%。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>time</span> python plot_eff.py
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>real	0m7.274s
user	0m20.875s
sys	0m0.857s
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=注意事项></a><h3>注意事项</h3><p>通过图形渲染流程来优化绘图时需要注意：<code>matplotlib</code>在绘图的时候如果使用<code>subplots</code>创建<code>Figure</code>对象，添加<code>colorbar</code>的时候，图形对象会进行自适应，删除<code>colorbar</code>之后<code>axes</code>的位置并不会自动适应到原始位置，此时如果添加新的图层和<code>colorbar</code>，会导致新的<code>Figure</code>对象中的<code>axes</code>的位置再次缩小。每重复一次删除/更新操作，<code>axes</code>的位置会缩小一些，重复越多，<code>axes</code>越小。</p><div class="admonition note"><p class=admonition-title><i class="icon fas fa-pencil-alt"></i>Note</p><p>解决方法如下：可通过如下方式创建<code>Figure</code>图像，固定<code>contourf</code>的<code>axes</code>和<code>colorbar</code>的<code>axes</code>，这样每次删除/更新新图层时就不会出现上述问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>Figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span><span class=p>)</span>

<span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_axes</span><span class=p>(</span><span class=p>[</span><span class=mf>0.12</span><span class=p>,</span> <span class=mf>0.11</span><span class=p>,</span> <span class=mf>0.64</span><span class=p>,</span> <span class=mf>0.77</span><span class=p>]</span><span class=p>)</span>
<span class=n>cax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_axes</span><span class=p>(</span><span class=p>[</span><span class=mf>0.78</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.022</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>]</span><span class=p>)</span>
</code></pre></td></tr></table></div></div></div><p>当然，<code>subplots</code>应该也有自适应的方式，但是尝试了很多方法都没有实现，暂时先放下了。尝试了更新<code>axes</code>的位置，然后更新图形：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>gp</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>get_position</span><span class=p>(</span><span class=p>)</span>

<span class=n>ax</span><span class=o>.</span><span class=n>set_position</span><span class=p>(</span><span class=n>gp</span><span class=p>)</span>
<span class=n>ax</span><span class=o>.</span><span class=n>autoscale</span><span class=p>(</span><span class=p>)</span>
<span class=n>ax</span><span class=o>.</span><span class=n>relim</span><span class=p>(</span><span class=p>)</span>
<span class=n>fig</span><span class=o>.</span><span class=n>canvas</span><span class=o>.</span><span class=n>draw</span><span class=p>(</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>但是并未解决上述问题。</p><a class=post-dummy-target id=参考链接></a><h3>参考链接</h3><ol><li><a href=https://stackoverflow.com/questions/27345157/matplotlib-how-to-remove-just-one-contour-element-from-axis-with-other-plotted>https://stackoverflow.com/questions/27345157/matplotlib-how-to-remove-just-one-contour-element-from-axis-with-other-plotted</a></li><li><a href=https://stackoverflow.com/questions/4981815/how-to-remove-lines-in-a-matplotlib-plot>https://stackoverflow.com/questions/4981815/how-to-remove-lines-in-a-matplotlib-plot</a></li><li><a href=https://stackoverflow.com/questions/21565445/matplotlib-says-fig-canvas-is-none-so-i-cant-use-fig-canvas-draw>https://stackoverflow.com/questions/21565445/matplotlib-says-fig-canvas-is-none-so-i-cant-use-fig-canvas-draw</a></li></ol></div><br><h3>相关文章</h3><li><a href=https://atmosai.github.io/2018/12/2018-12-04-%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E8%83%8C%E6%99%AF%E5%9B%BE/>如何添加背景图</a></li><li><a href=https://atmosai.github.io/2017/02/2019-02-01-python%E5%9C%B0%E5%9B%BE%E7%BB%98%E5%88%B6%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%8D%97%E6%B5%B7%E5%B0%8F%E5%9C%B0%E5%9B%BE/>Python地图绘制并添加南海小地图</a></li><div class=post-footer id=post-footer><div style="padding:10px 0;margin:20px auto;width:100%;font-size:16px;text-align:center"><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>打赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=/img/Wechat.jpeg alt="WeChat Pay"></a><p>微信打赏</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=/img/Alipay.jpeg alt=Alipay></a><p>支付宝打赏</p></div></div></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2020-01-27</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2fmatplotlib%25E9%25AB%2598%25E6%2595%2588%25E6%2589%25B9%25E9%2587%258F%25E5%2587%25BA%25E5%259B%25BE%2f&text=%e6%8f%90%e9%ab%98matplotlib%e7%9a%84%e5%87%ba%e5%9b%be%e6%95%88%e7%8e%87&via=xxxx" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2fmatplotlib%25E9%25AB%2598%25E6%2595%2588%25E6%2589%25B9%25E9%2587%258F%25E5%2587%25BA%25E5%259B%25BE%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2fmatplotlib%25E9%25AB%2598%25E6%2595%2588%25E6%2589%25B9%25E9%2587%258F%25E5%2587%25BA%25E5%259B%25BE%2f&title=%e6%8f%90%e9%ab%98matplotlib%e7%9a%84%e5%87%ba%e5%9b%be%e6%95%88%e7%8e%87" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//service.weibo.com/share/share.php?url=https%3a%2f%2fatmosai.github.io%2f2020%2f01%2fmatplotlib%25E9%25AB%2598%25E6%2595%2588%25E6%2589%25B9%25E9%2587%258F%25E5%2587%25BA%25E5%259B%25BE%2f&appkey=&title=%e6%8f%90%e9%ab%98matplotlib%e7%9a%84%e5%87%ba%e5%9b%be%e6%95%88%e7%8e%87&pic=%2fimg%2fmatplotlib2.jpg" target=_blank title="Share on Weibo"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://atmosai.github.io/tags/matplotlib/><i class="fas fa-tag fa-fw"></i>&nbsp;matplotlib</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://atmosai.github.io>Home</a></span></section></div><div class=post-nav><a href=https://atmosai.github.io/2020/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF/ class=prev rel=prev title=记一次非常奇怪的WRF-CMAQ错误><i class="fas fa-angle-left fa-fw"></i>记一次非常奇怪的WRF-CMAQ错误</a>
<a href=https://atmosai.github.io/2020/01/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E6%8F%90%E5%8D%871000-%E5%80%8D/ class=next rel=next title=数据处理速度提升1000+倍>数据处理速度提升1000+倍<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://atmosai.github.io target=_blank>bugsuse</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span>
</a><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></body></html>