<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>NetCDF文件网格数据重采样 | bugsuse</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="About LoveIt Theme"><link rel=prev href=https://atmosai.github.io/2018/04/2018-04-29-%E5%9F%BA%E4%BA%8E%E9%9B%B7%E8%BE%BE%E6%95%B0%E6%8D%AE%E7%9A%84%E9%A3%8E%E5%9C%BA%E5%8F%8D%E6%BC%94/><link rel=next href=https://atmosai.github.io/2018/11/2018-11-17-mac%E5%AE%89%E8%A3%85qgis/><link rel=canonical href=https://atmosai.github.io/2018/11/2018-11-14-netcdf%E6%96%87%E4%BB%B6%E7%BD%91%E6%A0%BC%E9%87%8D%E9%87%87%E6%A0%B7/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta property="og:title" content="NetCDF文件网格数据重采样"><meta property="og:description" content="无论是应用再分析数据作为模式输入还是后处理过程需要，对不同分辨率的NetCDF文件数据进行重新采样是非常必要的。 最近由于项目原因，需要对模式"><meta property="og:type" content="article"><meta property="og:url" content="https://atmosai.github.io/2018/11/2018-11-14-netcdf%E6%96%87%E4%BB%B6%E7%BD%91%E6%A0%BC%E9%87%8D%E9%87%87%E6%A0%B7/"><meta property="article:published_time" content="2018-11-14T19:16:36+08:00"><meta property="article:modified_time" content="2018-11-14T19:16:36+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="NetCDF文件网格数据重采样"><meta name=twitter:description content="无论是应用再分析数据作为模式输入还是后处理过程需要，对不同分辨率的NetCDF文件数据进行重新采样是非常必要的。 最近由于项目原因，需要对模式"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"NetCDF文件网格数据重采样","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/atmosai.github.io\/2018\/11\/2018-11-14-netcdf%E6%96%87%E4%BB%B6%E7%BD%91%E6%A0%BC%E9%87%8D%E9%87%87%E6%A0%B7\/"},"image":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"nco","wordcount":1338,"url":"https:\/\/atmosai.github.io\/2018\/11\/2018-11-14-netcdf%E6%96%87%E4%BB%B6%E7%BD%91%E6%A0%BC%E9%87%8D%E9%87%87%E6%A0%B7\/","datePublished":"2018-11-14T19:16:36\x2b08:00","dateModified":"2018-11-14T19:16:36\x2b08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"bugsuse","logo":{"@type":"ImageObject","url":"https:\/\/atmosai.github.io\/img\/res.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=navbar-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://atmosai.github.io>bugsuse</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://atmosai.github.io/posts>Posts</a><a class=menu-item href=https://atmosai.github.io/atmos>Atmos</a><a class=menu-item href=https://atmosai.github.io/model>Model</a><a class=menu-item href=https://atmosai.github.io/tools>Tools</a><a class=menu-item href=https://atmosai.github.io/cheats>CheatSheet</a><a class=menu-item href=https://atmosai.github.io/tags>Tags</a><a class=menu-item href=https://atmosai.github.io/categories>Categories</a><a class=menu-item href=https://atmosai.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">NetCDF文件网格数据重采样</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://i-lightning.cn rel=author target=_blank><i class="fas fa-user-circle fa-fw"></i>bugsuse
</a>&nbsp;<span class=post-category>included in&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://atmosai.github.io/categories/atmos/>Atmos</a>&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://atmosai.github.io/categories/tools/>Tools</a>&nbsp;</span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2018-11-14>2018-11-14</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1338 words&nbsp;
<i class="far fa-clock fa-fw"></i>3 min&nbsp;<span id=/2018/11/2018-11-14-netcdf%E6%96%87%E4%BB%B6%E7%BD%91%E6%A0%BC%E9%87%8D%E9%87%87%E6%A0%B7/ class=leancloud_visitors data-flag-title=NetCDF文件网格数据重采样>
<i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>pageviews
</span>&nbsp;</div></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#使用-esmf_regridweightgen-创建权重文件>使用 ESMF_RegridWeightGen 创建权重文件</a></li><li><a href=#regridding-掩膜字段>Regridding 掩膜字段</a></li><li><a href=#使用-ncks-进行网格重塑>使用 ncks 进行网格重塑</a></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#使用-esmf_regridweightgen-创建权重文件>使用 ESMF_RegridWeightGen 创建权重文件</a></li><li><a href=#regridding-掩膜字段>Regridding 掩膜字段</a></li><li><a href=#使用-ncks-进行网格重塑>使用 ncks 进行网格重塑</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>无论是应用再分析数据作为模式输入还是后处理过程需要，对不同分辨率的NetCDF文件数据进行重新采样是非常必要的。</p><p>最近由于项目原因，需要对模式结果进行网格重塑，期间了解了不少工具，发现nco和cdo在进行NetCDF操作时功能非常的强大，而且效率也比较高。本文将从其中一个方面记录对NetCDF文件的重采样过程。</p><p>从概念上来说，将网格插值为新分辨率是一种简单操作。可以看作是一种稀疏矩阵乘法，即 $s W=t$，矩阵W则是从网格 s 映射到网格 t 所使用的权重。有很多库可以计算不同网格映射时的权重矩阵，而且也可以进行矩阵乘法操作。Oasis coupler使用 <a href=https://www.mcs.anl.gov/research/projects/mct/ target=_blank>MCT</a>库在耦合模型中进行网格转换。<a href=https://www.earthsystemcog.org/projects/esmf/ target=_blank>ESMF</a>也提供了很多函数执行插值操作，下面提到的是其中一种计算权重的命令行工具。</p><p>针对大量文件的操作，权重的计算显得尤为重要。如果文件的网格是相同的，需要插值的新网格也是固定的，那么权重只需要计算一次即可。</p><a class=post-dummy-target id=使用-esmf_regridweightgen-创建权重文件></a><h3>使用 ESMF_RegridWeightGen 创建权重文件</h3><p>ESMF_RegridWeightGen能够直接从CF-NetCDF文件中读取网格信息然后直接生成重塑(regridding)权重。你也可以使用每个文件中的缺失值字段为源网格和目标网格定义<strong>掩膜(mask)</strong>。</p><p>对于高分辨率文件来说，创建权重矩阵需要使用大量的资源。最好的方式是使用并行运算。以下示例将7600x3600原数据插值到1536x1152。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=c1>#PBS -l ncpus=16</span>
<span class=c1>#PBS -l mem=64</span>
<span class=c1>#PBS -l walltime=30:00</span>
<span class=c1>#PBS -l wd</span>
 
module load esmf openmpi
<span class=nb>ulimit</span> -s unlimited
mpirun ESMF_RegridWeightGen -t GRIDSPEC -m neareststod  <span class=se>\
</span><span class=se></span>    -s SOURCE.nc --src_missingvalue SOURCE_FIELD <span class=se>\
</span><span class=se></span>    -d TARGET.nc --dst_missingvalue TARGET_FIELD <span class=se>\
</span><span class=se></span>    -w weights.nc --netcdf4
</code></pre></td></tr></table></div></div><p>上述示例中使用PBS作业管理系统使用16个核提交作业进行计算， module load 加载当前所安装的一些软件，module是linux中的软件管理工具，在集群管理中非常方便。</p><p><code>ulimit -s unlimited</code> 则是解除内存限制，防止出现 segamentation fault的错误。</p><p><strong>ESMF_RegridWeightGen</strong> 参数：</p><ul><li><code>-t</code>：定义了网格类型<ul><li><code>GRIDSPEC</code>：从CF-NetCDF文件中读取网格类型</li><li><code>SCRIP</code>：读取SCRIP格式中的网格</li></ul></li><li><code>-m</code>：网格重塑(regridding)方法<ul><li><code>bilinear</code>：双线性插值</li><li><code>patch</code>：高阶插值</li><li><code>neareststod</code>：映射源网格中与目标网格点中最邻近的点(仅应用一个点到目标格点)</li><li><code>nearestdtos</code>: 映射源网格中与目标网格点中最邻近的点(可以映射多个源网格点到一个目标点)</li><li><code>conserve</code>: 传统映射方法 (需要额外边界信息来计算网格面积)</li></ul></li><li><code>-s</code>：<code>SOURCE.nc</code>：需要regrid的样本文件</li><li><code>-src_missingvalue SOURCE_FIELD</code>: <code>SOURCE.nc</code> 中定义源网格的mask，(应该通过<code>_FillValue</code> 或 <code>missing_value</code> 属性进行设置)</li><li><code>-d TARGET.nc</code>: 目标网格文件</li><li><code>-dst_missingvalue TARGET_FIELD</code>: <code>TARGET.nc</code> 文件中定义目标网格 mask (应该通过<code>_FillValue</code> 或 <code>missing_value</code> 属性进行设置)</li><li><code>-w weights.nc</code>: 网格重塑权重文件</li><li><code>--netcdf4</code>: 输出为NetCDF4格式</li></ul><p>完整参数列表以及源网格格式信息参见 <a href=http://www.earthsystemmodeling.org/esmf_releases/public/ESMF_6_3_0rp1/ESMF_refdoc/node3.html#SECTION03020000000000000000 target=_blank>ESMF_RegridWeightGen documentation</a></p><a class=post-dummy-target id=regridding-掩膜字段></a><h3>Regridding 掩膜字段</h3><p>如果源网格或者目标网格需要进行掩膜操作，那么可能目标网格中的一些点不会出现在源网格中，例如其中一个文件中有湖但是另一个文件中没有。如果这样的话 ESMF_RegridWeightGen 将会出错并将错误信息输出到日志文件。为了避免出现这种情况，可以使用 <code>neareststod</code> 方法插值或者使用 <code>--ignore</code>选项忽略缺失值错误，然后在插值完成之后将缺失点添加到文件中。</p><a class=post-dummy-target id=使用-ncks-进行网格重塑></a><h3>使用 ncks 进行网格重塑</h3><p>生成权重文件之后，便可以使用 ncks 进行数据转换了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ncks --map weights.nc input.nc output.nc
</code></pre></td></tr></table></div></div><p>ncks 是 nco 中的一个命令行工具，使用之前需要先安装 nco。除了自行编译 nco 之外，可以通过 Anaconda 的 conda 包管理器进行安装。</p></div><div class=post-footer id=post-footer><div style="padding:10px 0;margin:20px auto;width:100%;font-size:16px;text-align:center"><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>打赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=/img/Wechat.jpeg alt="WeChat Pay"></a><p>微信打赏</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=/img/Alipay.jpeg alt=Alipay></a><p>支付宝打赏</p></div></div></div><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2018-11-14</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fatmosai.github.io%2f2018%2f11%2f2018-11-14-netcdf%25E6%2596%2587%25E4%25BB%25B6%25E7%25BD%2591%25E6%25A0%25BC%25E9%2587%258D%25E9%2587%2587%25E6%25A0%25B7%2f&text=NetCDF%e6%96%87%e4%bb%b6%e7%bd%91%e6%a0%bc%e6%95%b0%e6%8d%ae%e9%87%8d%e9%87%87%e6%a0%b7&via=xxxx" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fatmosai.github.io%2f2018%2f11%2f2018-11-14-netcdf%25E6%2596%2587%25E4%25BB%25B6%25E7%25BD%2591%25E6%25A0%25BC%25E9%2587%258D%25E9%2587%2587%25E6%25A0%25B7%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fatmosai.github.io%2f2018%2f11%2f2018-11-14-netcdf%25E6%2596%2587%25E4%25BB%25B6%25E7%25BD%2591%25E6%25A0%25BC%25E9%2587%258D%25E9%2587%2587%25E6%25A0%25B7%2f&title=NetCDF%e6%96%87%e4%bb%b6%e7%bd%91%e6%a0%bc%e6%95%b0%e6%8d%ae%e9%87%8d%e9%87%87%e6%a0%b7" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//service.weibo.com/share/share.php?url=https%3a%2f%2fatmosai.github.io%2f2018%2f11%2f2018-11-14-netcdf%25E6%2596%2587%25E4%25BB%25B6%25E7%25BD%2591%25E6%25A0%25BC%25E9%2587%258D%25E9%2587%2587%25E6%25A0%25B7%2f&appkey=&title=NetCDF%e6%96%87%e4%bb%b6%e7%bd%91%e6%a0%bc%e6%95%b0%e6%8d%ae%e9%87%8d%e9%87%87%e6%a0%b7" target=_blank title="Share on Weibo"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://atmosai.github.io/tags/nco/><i class="fas fa-tag fa-fw"></i>&nbsp;nco</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://atmosai.github.io>Home</a></span></section></div><div class=post-nav><a href=https://atmosai.github.io/2018/04/2018-04-29-%E5%9F%BA%E4%BA%8E%E9%9B%B7%E8%BE%BE%E6%95%B0%E6%8D%AE%E7%9A%84%E9%A3%8E%E5%9C%BA%E5%8F%8D%E6%BC%94/ class=prev rel=prev title=基于多普勒雷达数据的风场反演><i class="fas fa-angle-left fa-fw"></i>基于多普勒雷达数据的风场反演</a>
<a href=https://atmosai.github.io/2018/11/2018-11-17-mac%E5%AE%89%E8%A3%85qgis/ class=next rel=next title=Mac安装QGIS>Mac安装QGIS<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=vcomments></div><script src=/js/lib/valine/Valine.min.min.js></script><script src=//cdn1.lncld.net/static/js/3.0.4/av-min.js></script><script src=//unpkg.com/valine/dist/Valine.min.js></script><script type=text/javascript>new Valine({el:"#vcomments",appId:"twlK9oFHfQ0uMlYbl7ohmJaw-gzGzoHsz",appKey:"EH1DRk4P5vyMn6SmoQStahoN",meta:["nick","mail"],notify:"true",verify:"true",avatar:"mp",placeholder:"",visitor:"true",recordIP:"true",lang:"en",emoticon_url:'https://cloud.panjunwen.com/alu',emoticon_list:["狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","暗地观察.png"],});</script><noscript>Please enable JavaScript to view the <a href=https://valine.js.org/>comments powered by Valine.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://atmosai.github.io target=_blank>bugsuse</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-112932643-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></body></html>